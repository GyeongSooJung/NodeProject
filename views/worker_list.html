{% extends 'layout.html' %}

{% block css %}
<link href="../assets/plugins/datatables.net-bs4/css/dataTables.bootstrap4.min.css" rel="stylesheet" />
<link href="../assets/plugins/datatables.net-responsive-bs4/css/responsive.bootstrap4.min.css" rel="stylesheet" />
<link href="../assets/plugins/datatables.net-buttons-bs4/css/buttons.bootstrap4.min.css" rel="stylesheet" />
<link href="../assets/plugins/datatables.net-autofill-bs4/css/autoFill.bootstrap4.min.css" rel="stylesheet" />
<link href="../assets/plugins/datatables.net-colreorder-bs4/css/colReorder.bootstrap4.min.css" rel="stylesheet" />
<link href="../assets/plugins/datatables.net-keytable-bs4/css/keyTable.bootstrap4.min.css" rel="stylesheet" />
<link href="../assets/plugins/datatables.net-rowreorder-bs4/css/rowReorder.bootstrap4.min.css" rel="stylesheet" />
<link href="../assets/plugins/datatables.net-select-bs4/css/select.bootstrap4.min.css" rel="stylesheet" />
<link href="../assets/plugins/switchery/switchery.min.css" rel="stylesheet" />
<link href="../assets/plugins/abpetkov-powerange/dist/powerange.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<!-- begin #content -->
<div id="content" class="content">
	<!-- begin page-header -->
	<h1 class="page-header">{{__('worker_list')}}</h1>
	<!-- end page-header -->
	<!-- begin row -->
	<div class="row">
		<!-- begin col-12 -->
		<div class="col-xl-12">
			<div class="panel panel-inverse">
				<!-- begin panel-heading -->
				<div class="panel-heading">
					<h4 class="panel-title">{{__('staff')}}</h4>
				</div>
				<!-- end panel-heading -->
				<!-- begin panel-body -->
				<div class="panel-body">
					
					<div class="mt-2 mb-2 d-flex justify-content-end align-items-center">
		        	<div class="mr-2">
		            		<div class="btn-group m-r-5 m-b-5">
									<a id="searchoption" href="javascript:;" class="btn btn-default">{{__('search')}}</a>
									<a href="#" data-toggle="dropdown" class="btn btn-default dropdown-toggle" aria-expanded="false"><b class="caret"></b></a>
									<div class="dropdown-menu dropdown-menu-right" style="">
										<a href="javascript:searchoption('WN');" class="dropdown-item">{{__('name')}}</a>
										<a href="javascript:searchoption('PN');" class="dropdown-item">{{__('mobile_number')}}</a>
										<a href="javascript:searchoption('EM');" class="dropdown-item">{{__('email')}}</a>
									
									</div>
							</div> 
					</div>
					<div>
			  				<input id ="searchtext" type="text" class="form-control" placeholder ="" />
			  			</div>
			  			<div id ="searchdatetext" class="d-none">
			  				<div class ="d-flex">
			  				<input type="date" id = "searchdatetext1" class ="form-control" placeholder ="" />
			  				&nbsp;&nbsp;~&nbsp;&nbsp;
			  				<input type="date" id = "searchdatetext2" class ="form-control" placeholder ="" />
			  				</div>
			  			</div>
			  			<div>
			  				
			  				<button id ="searchbutton" class="ml-1 btn btn-primary text-white px-1" onclick="searchbutton()"><i class="mx-1 fas fa-lg fa-fw fa-search align-items-center"></i></button></div>
			  			<a href='javascript:;' id ="gotolist" onclick=gotolist() class='d-none ml-1 btn btn-primary mr-1 px-2'>전체목록</a>
		   			</div>
					
					<div class="overflow-auto">
					    <form action="/worker/worker_update" method="post">
					        <table id="data-table-combine" class="table table-striped table-bordered table-hover table-td-valign-middle text-center">
	        					<thead>
	        						<tr>
		        							<th width="1%"><input type="checkbox" class="neHeros" value="" onChange="allCheckedBox(this);"/></th>
		        							<th width="2.5%"></th>
		        							<th width="2.5%" data-orderable="false"></th>
		        							<th width="15%" class = "sort" name = "WN">{{__('name')}}<i id = "WN" class="d-none  float-right mx-1 fas fa-lg fa-fw m-t-3 fa-angle-down"></i></th>
		        							<th width="15%" class = "sort" name = "PN">{{__('mobile_number')}}<i id = "PN" class="d-none  float-right mx-1 fas fa-lg fa-fw m-t-3 fa-angle-down"></i></th>
		        							<th width="15%" class = "sort" name = "EM">{{__('email')}}<i id = "EM" class="d-none  float-right mx-1 fas fa-lg fa-fw m-t-3 fa-angle-down"></i></th>
		        							<th width="10%">{{__('owner_auth')}}</th>
		        							<th width="10%">{{__('approval')}}</th>
		        							<th width="1%"></th>
	        						</tr>
	        					</thead>
	        					<tbody id ="memDiv">
									
	        					</tbody>
	        				</table>
							<div class="justify-content-between align-item-center">
								<center>
										<div id="pagebox" class=" justify-content-around align-item-center">
											
										</div>
								</center>
							</div>
					    </form>
				    </div>
				</div>
				<!-- end panel-body -->
			</div>
		</div>
		<!-- end col-10 -->
	</div>
	<!-- end row -->
</div>
<!-- end #content -->
	
<script src="http://code.jquery.com/jquery-1.10.2.js"></script>	
<script>
	var pagingObject = new Object({array : [], sort : "CA", page : 0, postNum : 10, pageNum : 5, startpage : 0, endpage : 0, search: "", searchtext : ""});
		// 검색 기능
		
	$(document).ready(function(){
		pagereload()
		
        $('.ck_au').change(function() {
	           var post = 'POST METHOD CALL';
	           var email = $(this).val();
				
		         if($(this).is(":checked")){
	                //Ajax POST Method TEST
					$.ajax({
						url: '/ajax/post',
						dataType: 'json',
						type: 'POST',
						data: {au_true:email},
						success: function(result) {
							if (result) {
							 $('#post_output').html(result.result);
							}
						}
					});
		         }
		         else {
	                //Ajax POST Method TEST
	                $.ajax({
						url: '/ajax/post',
						dataType: 'json',
						type: 'POST',
						data: {au_false:email},
						success: function(result) {
							if (result) {
								$('#post_output').html(result.result);
							}
	                    }
					});
		         }
	        });
	        
		$('.ck_ac').change(function() {
			   var post = 'POST METHOD CALL';
			   var email = $(this).val();
				
			     if($(this).is(":checked")){
		            //Ajax POST Method TEST
		            $.ajax({
						url: '/ajax/post',
						dataType: 'json',
						type: 'POST',
						data: {ac_true:email},
						success: function(result) {
							if (result) {
								$('#post_output').html(result.result);
							}
						}
					});
			    }
			    else {
		            //Ajax POST Method TEST
		            $.ajax({
						url: '/ajax/post',
						dataType: 'json',
						type: 'POST',
						data: {ac_false:email},
						success: function(result) {
							if (result) {
								$('#post_output').html(result.result);
							}
						}
					});
				}
			});
	        
	        
	        $('#searchtext').keyup(function(key) {
        		if(key.keyCode == 13) {
        			if(pagingObject.search == "")
        			alert("{{__('choice_error')}}");
        			else {
        				pagingObject.searchtext = $(this).val();
        				pagereload()
        				document.getElementById('gotolist').classList.remove('d-none');
        			}
        		}
        		if($(this).val() == "") {
        			pagereload()
        		}
        	})
        	
        	
        	$('.sort').click(function() {
        		console.log("@@@")
        		
        		$("#searchoption").empty();
            	$("#searchoption").append("{{__('search')}}");
        		
        		pagingObject.search = "";
        		pagingObject.searchtext = "";
        		
        		var paglist = pagingObject.array;
        		
        		var check_sort = $(this).attr('name');
        		
        		
        		 if(document.getElementById(check_sort).classList.contains('d-none')) {
        		 	
        		 	document.getElementById(check_sort).classList.remove('fa-angle-up');
	        		document.getElementById(check_sort).classList.add('fa-angle-down');
        		 	var check2 = check_sort;
        		 }
        		 else {
        		 	if (document.getElementById(check_sort).classList.contains('fa-angle-down')) {
        		 		
	        		 	document.getElementById(check_sort).classList.remove('fa-angle-down');
	        		 	document.getElementById(check_sort).classList.add('fa-angle-up');
        		 		var check2 = check_sort + "2";
        		 	}
        		 	else {
        		 		
        		 		document.getElementById(check_sort).classList.remove('fa-angle-up');
	        		 	document.getElementById(check_sort).classList.add('fa-angle-down');
        		 		var check2 = check_sort;
        		 		
        		 	}
        		 }
        		 

        		document.getElementById('WN').classList.add('d-none');
        		document.getElementById('PN').classList.add('d-none');
        		document.getElementById('EM').classList.add('d-none');
        		
        		
        		document.getElementById(check_sort).classList.remove('d-none');
        		
        		
        		pagingObject.array = paglist;
        		pagingObject.sort = check2;
        		pagingObject.page = 0;
        		pagereload();
        		
        	})
	    })
	    
	    //초기화
	    function refresh() {
	    	pagingObject.array = [];
	    	pagingObject.sort = "CA";
	    	pagingObject.page = 0;
	    	pagingObject.postNum = 10;
	    	pagingObject.pageNum = 5;
	    	pagingObject.startpage = 0;
	    	pagingObject.endpage = 0;
	    	pagingObject.search = "";
	    	pagingObject.searchtext = "";
	    	
	    	
	    }
	    
		function searchoption(opt) {
    	pagingObject.search = opt;
    	$("#searchoption").empty();
    	var string = opt;
    	
    	if (string == "WN")
    	   string = "{{__('name')}}";
    	   document.getElementById('searchtext').classList.remove('d-none');
    	   document.getElementById('searchdatetext').classList.add('d-none');
    	if (string == "PN")
    	   string = "{{__('mobile_number')}}";
    	   document.getElementById('searchtext').classList.remove('d-none');
    	   document.getElementById('searchdatetext').classList.add('d-none');
    	if (string == "EM") {
       	   string = "{{__('email')}}";
       	   console.log(string)
    	   document.getElementById('searchtext').classList.remove('d-none');
    	   document.getElementById('searchdatetext').classList.add('d-none');
    	   
    	}
    	
    	$("#searchoption").append(string);
    	$("#searchoption").show();
        }
		
		function searchbutton() {
    	
	    	if(pagingObject.search == "")
	          alert("{{__('search_option_error')}}");
	        else {
					pagingObject.searchtext = $('#searchtext').val();
					pagereload()
					document.getElementById('gotolist').classList.remove('d-none');
	        	document.getElementById('searchtext').classList.remove('d-none');
    			document.getElementById('searchdatetext').classList.add('d-none');
			}
			$("#searchoption").empty();
			$("#searchoption").append("{{__('search')}}");
			$("#searchoption").show();
		}
		
		
		// 전체 목록으로
		function gotolist() {
			
			refresh()
			pagereload()
			
			$("#searchoption").empty();
			$("#searchoption").append("{{__('search')}}");
			document.getElementById('gotolist').classList.add('d-none');
		}
		
		// 페이지 기능
		function pagebutton(num) {
			pagingObject.page = num;
	    	pagereload()
	    }
	    
		function pageBtn(dir,page) {
			if(dir == 'left') {
				if((pagingObject.page - 1) > -1)
				{
					pagingObject.page -= 1;
					pagereload()
				}
			}
			if(dir == 'right') {
				if((pagingObject.page + 1) < Math.ceil(pagingObject.array.length / pagingObject.postNum))
				{
					pagingObject.page += 1;
					pagereload()
					
				}
				
			}
		}
		
		function pageDoubleBtn(dir,page) {
			if(dir == 'left') {
				if((pagingObject.page - pagingObject.pageNum) < 0) {
					pagingObject.page = 0;
					pagereload()
				}
				else {
					pagingObject.startpage -= 1;
					pagingObject.page -= 5;
					pagereload()
				}
			}
			if(dir == 'right') {
				console.log(pagingObject.page)
				console.log(pagingObject.pageNum)
				console.log(pagingObject.array.length)
				console.log(pagingObject.postNum)
				if ((pagingObject.page + pagingObject.pageNum) >= Math.ceil(pagingObject.array.length / pagingObject.postNum))
				{
					console.log("@@@")
					pagingObject.page = Math.ceil(pagingObject.array.length / pagingObject.postNum)-1;
					pagereload()
				}
				else {
					pagingObject.startpage += 1;
					pagingObject.page += 5;
					pagereload()
				}
			}
		}
		
		function pagereload() {
    	    $.ajax({
	    		url: "/ajax/worker_list",
	                    type: "POST",
	                    async: false,
	                    dataType: 'json',
	                    data: {
	                        sort : pagingObject.sort,
	                        search : pagingObject.search,
	                        searchtext : pagingObject.searchtext
	                    }
	        }).done(function (data) { 
	        	if(data.result == true) {
		    		    pagingObject.array = data.workerlist;
		    		    pagingObject.startpage = Math.floor((pagingObject.page) / pagingObject.pageNum) * pagingObject.pageNum;
		    		    pagingObject.endpage = pagingObject.startpage + pagingObject.pageNum;
		    		    
		    		    var workerlist = pagingObject.array; // 전체 리스트
		    		    var workernum = workerlist.length; // 전체 리스트의 갯수
		    		    var page = pagingObject.page; // 페이지 번호
		    		    var startPage = pagingObject.startpage; // 시작 페이지
		    		    var endPage = pagingObject.endpage; // 끝 페이지
		    		    var postNum = pagingObject.postNum; // 게시될 페이지 숫자
		    		    var pageNum = pagingObject.pageNum; // 페이지 번호의 갯수
		    		    var totalPage = Math.ceil(workernum/postNum); // 전체 페이지의 갯수
		    		    
		    		    if (endPage > totalPage) { // 끝 페이지가 총 페이지 수보다 많다면 같게끔 처리
					        endPage = totalPage;
					    }
		    		    
			        	//tr 초기화
			        	$("#data-table-combine > tbody > tr").remove();
			        	//페이지 넘버 박스 초기화
				     	$("#pagebox *").remove(); 
				    		
				     	var insertTr = ""; // 채워넣을 HTML 초기화
				     	
				     	var indexcount = 1; // 인덱스번호 초기화
				    		
				    	
				    	
				    	
				     	for (var i = (postNum * page) ; i < (postNum * page) + postNum ; i ++) { // 현재 페이지의 번호에 맞는 리스트 뽑아서 출력 (0 ~ 9, 10 ~ 19)
				     	   if(workerlist[i]) {
				     	   	console.log(workerlist)
							  insertTr += "<tr>";
							  insertTr += " 	<td class='with-btn' nowrap>";
							  insertTr += "		<input id='ck' type='checkbox' name ='ck' class='neHeros' value="+ workerlist[i].EM +" onChange='eachCheckedBox(this);'/>";
							  insertTr += " 	</td>";
							  insertTr += "<td class='font-weight-bold'>"+(workernum - (page*10)) +" </td>";
							  insertTr += "<td class='with-img'><img src='"+ workerlist[i].PU +"' class='img-rounded height-30' /></td>";
							  insertTr += "<td>"+ workerlist[i].WN+"</td>";
							  insertTr += "<td>"+ workerlist[i].PN+"</td>";
							  insertTr += "<td>"+ workerlist[i].EM+"</td>";
							  insertTr += "<td class='with-btn' nowrap>";
		        			  insertTr += "<input class ='ck_au' type='checkbox' data-render='switchery' data-theme='black' value ='"+workerlist[i].EM+"'";
		        			  if(workerlist[i].AU ==1)
		        				insertTr += "checked/>";
		        			  else
		        				insertTr += "unchecked/>";
		        			  insertTr += "</td>";
		        			  insertTr += "<td class='with-btn' nowrap>";
		        			  insertTr += "<input class ='ck_ac' type='checkbox' data-render='switchery' data-theme='default' value ='"+workerlist[i].EM+"'";
		        			  if(workerlist[i].AC ==1)
		        				insertTr += "checked/>";
		        			  else
		        				insertTr += "unchecked/>";
		        			  insertTr += "</td>";
		        			  insertTr += "<td>";
		        			  insertTr += "<input type='button' value='{{__('delete')}}' onclick=delete_one(this) class='btn btn-sm btn-white width-60' name ='"+ workerlist[i].EM +"'></td> ";
		        			  insertTr += "</td>";
							  insertTr += "</tr>";
							  workernum -= indexcount;
							  
				     	   }
				     	}
							  console.log(insertTr)
							  $("#memDiv").append(insertTr);
							  insertTr = " ";
					    	  insertTr +=	"<a href='javascript:;' onclick=pageDoubleBtn('left',"+page+") class='btn btn-primary mr-1 px-2'><i class='fas fa-angle-double-left'></i></a>";
							  insertTr +=	"<a href='javascript:;' onclick=pageBtn('left',"+page+") class='btn btn-primary mr-1 px-2'><i class='fas fa-angle-left'></i></a>";
		
								for(var i = startPage; i < endPage; i ++) {
									if(page == i)
										insertTr +=	"<input type='button' onclick='pagebutton("+ i +")' value ='"+ (i+1) +"' class='btn btn-white mr-1 px-2 text-primary' style=' background-color: #00acac; color: white !important;' >";
									else
										insertTr +=	"<input type='button' onclick='pagebutton("+ i +")' value ='"+ (i+1) +"' class='btn btn-white mr-1 px-2 text-primary' >";
								}
								insertTr +=	"<a href='javascript:;' onclick=pageBtn('right',"+page+") class='btn btn-primary mr-1 px-2'><i class='fas fa-angle-right'></i></a>";
								insertTr +=	"<a href='javascript:;' onclick=pageDoubleBtn('right',"+page+") class='btn btn-primary mr-1 px-2'><i class='fas fa-angle-double-right'></i></a>";
							  $("#pagebox").append(insertTr);
							  $("#pagebox").show();
	        	}
	        	
	        	else if (data.result == "nothing") {
	        		alert("{{__('search_error')}}")
	        	}
	        	
	        	else {
	        		alert("{{__('search_error')}}")
	        	}
			})
    	
    }

	    
	    // 에러 링크 기능
		window.onload = () => {
			if (new URL(location.href).searchParams.get('null')) {
				alert("{{__('choice_error')}}");
			}
		}
</script>
{% endblock %}


{% block script %}

<script src="../assets/plugins/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="../assets/plugins/datatables.net-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="../assets/plugins/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
<script src="../assets/plugins/datatables.net-responsive-bs4/js/responsive.bootstrap4.min.js"></script>
<script src="../assets/plugins/datatables.net-colreorder/js/dataTables.colReorder.min.js"></script>
<script src="../assets/plugins/datatables.net-colreorder-bs4/js/colReorder.bootstrap4.min.js"></script>
<script src="../assets/plugins/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
<script src="../assets/plugins/datatables.net-keytable-bs4/js/keyTable.bootstrap4.min.js"></script>
<script src="../assets/plugins/datatables.net-rowreorder-bs4/js/rowReorder.bootstrap4.min.js"></script>
<script src="../assets/plugins/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
<script src="../assets/plugins/datatables.net-buttons-bs4/js/buttons.bootstrap4.min.js"></script>
<script src="../assets/plugins/datatables.net-buttons/js/buttons.colVis.min.js"></script>
<script src="../assets/plugins/datatables.net-buttons/js/buttons.flash.min.js"></script>
<script src="../assets/plugins/datatables.net-buttons/js/buttons.html5.min.js"></script>
<script src="../assets/plugins/datatables.net-buttons/js/buttons.print.min.js"></script>
<script src="../assets/plugins/pdfmake/build/pdfmake.min.js"></script>
<script src="../assets/plugins/pdfmake/build/vfs_fonts.js"></script>
<script src="../assets/plugins/jszip/dist/jszip.min.js"></script>
<!--<script src="../assets/js/demo/table-manage-combine.demo.js"></script>-->
<script src="../assets/plugins/switchery/switchery.min.js"></script>
<script src="../assets/plugins/abpetkov-powerange/dist/powerange.min.js"></script>
<script src="../assets/js/demo/form-slider-switcher.demo.js"></script>
{% endblock %}