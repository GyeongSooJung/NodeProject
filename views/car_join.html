{% extends 'layout.html' %}

{% block content %}
<div id="content" class="content">
	<!-- begin page-header -->
	<h1 class="page-header">{{__('car_register')}}</h1>
	<!-- end page-header -->
	<!-- begin row -->
	<div class="row">
		<!-- begin col-6 -->
		<div class="col-xl-12">
			<!-- begin panel -->
			<div class="panel panel-inverse" data-sortable-id="form-validation-1">
				<!-- begin panel-heading -->
				<div class="panel-heading">
					<h4 class="panel-title">{{__('car')}}</h4>
					<p class="m-0">{{__('attachments')}} : </p>
					<span class="text-green font-weight-bold d-flex align-items-center">
						<a id="excel_file" class="text-green" href="../assets/upload/차량 등록 양식.xlsx" download>
							<i class="far fa-lg fa-file-excel ml-2 mr-1"></i> {{__('car_excel_form')}}.xlsx
						</a>
					</span>
				</div>
				<!-- end panel-heading -->
				<!-- begin panel-body -->
				<div id="car-form-div" class="panel-body">
					<form id="car-form" action="" method="post" class="form-horizontal" data-parsley-validate="true" name="car-form" onsubmit="carJoin();">
						<div class="form-group row m-b-15">
							<label class="col-md-4 col-sm-4 col-form-label" for="CN">{{__('car_number')}} <span class="text-danger">*</span> :</label>
							<div class="col-md-8 col-sm-8">
								<input class="form-control" type="String" id="CN" name="CN" placeholder="{{__('car_number_msg')}}" data-parsley-required="true" data-parsley-error-message="{{__('required_detail')}}" data-parsley-trim-value="true" />
							</div>
						</div>
						<div class="form-group row m-b-15">
							<label class="col-md-4 col-sm-4 col-form-label" for="CN">{{__('car_customer_phone')}} :</label>
							<div class="col-md-8 col-sm-8">
								<input class="form-control" type="String" id="CPN" name="CPN" placeholder="{{__('car_customer_phone')}}" data-parsley-type="digits" data-parsley-type-message="{{__('register_digits_error')}}" data-parsley-trim-value="true" />
							</div>
						</div>
						<div class="form-group row m-b-0">
							<label class="col-md-4 col-sm-4 col-form-label">&nbsp;</label>
							<div class="col-md-8 col-sm-8">
								<button type="submit" class="btn btn-primary width-80">{{__('registration')}}</button>
								<button type="reset" class="btn btn-primary width-80">{{__('reset')}}</button>
							</div>
						</div>
						<!--현재 시간 변수-->
						<input type="hidden" class="form-control" name = "Ctime" id = "Ctime" />
					</form>
				</div>
				<!-- Excel 파일 업로드 -->
				<div class="panel-body bg-grey pb-0">
					<form id="car-xlsx-form" action="/car_join_excel" method="post" enctype="multipart/form-data" class="form-horizontal" name="car-xlsx-form">
						<div class="form-group row m-b-15">
							<label class="col-md-4 col-sm-4 col-form-label text-green" for="file"><b># {{__('excel_register')}}</b> :</label>
							<div class="col-md-8 col-sm-8">
								<input type="file" id="xlsx" name="xlsx" /><button type="button" id="upload-btn" class="btn btn-primary width-80" onclick="pagereload(); pagingObjectInit();">{{__('registration')}}</button>
							</div>
						</div>
					</form>
				</div>
				<!-- end panel-body -->
				<!-- Excel 목록 확인 -->
				<div id="excel-table-div" class="panel-body overflow-auto position-relative d-none">
					<form id="car-form" action="/car/car_join" method="post" class="form-horizontal">
						<table id="excel-table" class="table table-bordered table-hover table-td-valign-middle text-center w-75 mx-auto">
							<thead class="thead-light">
								<tr>
									<th width="5%"></th>
									<th>{{__('car_number')}}</th>
									<th>{{__('car_customer_phone')}}</th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
					</form>
					<div id="pagination" class="d-flex justify-content-between align-item-center w-75 mx-auto d-none">
					</div>
				</div>
			</div>
			<!-- end panel -->
		</div>
	</div>
	<!-- end row -->
</div>

<!-- script -->
<script>
	
	// 폼 enter키 submit 막기
	document.addEventListener('keydown', function(event) {
		if (event.keyCode === 13) {
			event.preventDefault();
		}
	}, true);
</script>
{% endblock %}

{% block script %}
<script language ="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<script language="javascript">
	// 페이지 변수 선언
	var pagingObject = new Object({ array: [], page: 0, postNum: 50, pageNum: 5, startPage: 0, endPage: 0 });
	function pagingObjectInit() {
		pagingObject.array = [];
		pagingObject.page = 0;
		pagingObject.postNum = 50;
		pagingObject.pageNum = 5;
		pagingObject.startPage = 0;
		pagingObject.endPage = 0;
	}

	window.addEventListener('load', function() {
		var cookie = document.cookie;
		var startIndexOf = cookie.indexOf('lang=');
		var endIndexOf = cookie.indexOf(';',startIndexOf);
		if(endIndexOf == -1)endIndexOf = cookie.length; //맨끝일경우;가 없으므로 맨마지막자리를 가져온다.
		
		const sl = document.getElementById('select-lang');
		var lang = cookie.substring(startIndexOf+'lang='.length, endIndexOf);
		
		var excel_file = document.getElementById('excel_file');
		
		if(lang == 'ko') {
			excel_file.href="../assets/upload/차량 등록 양식.xlsx";
		}
		else if(lang == 'en') {
			excel_file.href="../assets/upload/Car Registration Form.xlsx";
		}
		else {
			excel_file.href="../assets/upload/차량 등록 양식.xlsx";
		}
		
		// 페이지함수
		pagereload();
	});
	
	// 페이지 숫자 버튼 기능
	function pagebutton(num) {
		pagingObject.page = num;
		
		pagereload();
	}
	
	// 페이지 넘김 버튼
	function pageBtn(dir, page) {
		if(dir == 'left') {
			if((pagingObject.page - 1) > -1) {
				pagingObject.page -= 1;
				
				pagereload();
			}
		}
		if(dir == 'right') {
			if((pagingObject.page + 1) < Math.ceil(pagingObject.array.length / pagingObject.postNum)) {
				pagingObject.page += 1;
				
				pagereload();
			}
		
		}
	}
	
	// 페이지 이중 넘김 버튼
	function pageDoubleBtn(dir,page) {
		if(dir == 'left') {
			if((pagingObject.page - pagingObject.pageNum) < 0) {
				pagingObject.page = 0;
				
				pagereload();
			}
			else {
				pagingObject.startpage -= 1;
				pagingObject.page -= 5;
				
				pagereload();
			}
		}
		if(dir == 'right') {
			if ((pagingObject.page + pagingObject.pageNum) > Math.ceil(pagingObject.array.length / pagingObject.postNum)) {
				pagingObject.page = Math.ceil(pagingObject.array.length / pagingObject.postNum)-1;
				pagereload()
			}
			else {
				pagingObject.startpage += 1;
				pagingObject.page += 5;
				pagereload()
			}
		}
	}
	
	function pagereload() {
		var form = $('#car-xlsx-form')[0];
		var data = new FormData(form);
		var pnu;
		
		$.ajax({
			type: 'POST',
			enctype: 'multipart/form-data',
			url: '/car/car_json_excel',
			data: data,
			processData: false,
        	contentType: false,
        	success: function(result) {
        		pagingObject.array = result.excelData;
        		pagingObject.startpage = Math.floor((pagingObject.page) / pagingObject.pageNum) * pagingObject.pageNum;
        		pagingObject.endpage = pagingObject.startpage + pagingObject.pageNum;
        		
        		var excelList = pagingObject.array; // 전체 리스트
        		var excelNum = excelList.length; // 전체 리스트 갯수
        		var page = pagingObject.page; // 페이지 번호
				var startPage = pagingObject.startpage; // 시작 페이지
				var endPage = pagingObject.endpage; // 끝 페이지
				var postNum = pagingObject.postNum; // 게시될 페이지 숫자
				var pageNum = pagingObject.pageNum; // 페이지 번호의 갯수
				var totalPage = Math.ceil(excelNum/postNum); // 전체 페이지의 갯수
				
				if(endPage > totalPage) {
					endPage = totalPage;
				}
        		
        		if (result.status == 'send') {
        			$('#car-form-div').hide();
					$('#pagination > *').remove();
					$('#excel-table > tbody > tr').remove();
        			$('#excel-table-div').removeClass('d-none');
        			$('#pagination').removeClass('d-none');
        			$('#excel-table > tbody:last').append("<input type='hidden' id='excelData' name='excelData' value='"+excelList+"'>");
        			pnu = "";
        			
        			for(var i = (postNum * page); i < (postNum * page) + postNum; i++) {
        				if(excelList[i]) {
	        				$('#excel-table > tbody:last').append("<tr>\
		        				<td>"+(i+1)+"</td>\
		        				<td>"+result.excelData[i][0]+"</td><input type='hidden' id='excelCN' name='excelCN' value='"+result.excelData[i][0]+"'>\
		        				<td>"+result.excelData[i][1]+"</td><input type='hidden' id='excelCPN' name='excelCPN' value='"+result.excelData[i][1]+"'>\
	    					</tr>");
        				}
        			}
        			
        			for(var j = startPage; j < endPage; j ++) {
						if(page == j) {
							pnu += "<input type='button' onclick='pagebutton("+ j +")' value ='"+ (j+1) +"' class='btn btn-white mr-1 px-2 text-primary' >";
						} else {
							pnu += "<input type='button' onclick='pagebutton("+ j +")' value ='"+ (j+1) +"' class='btn btn-white mr-1 px-2 text-primary' >";
						}
					}
        			
        			$('#pagination').append("\
    					<input class='btn btn-primary width-80 excelJoinBtn' type='button' value='{{__('registration')}}'>\
    					<div class='d-flex justify-content-around align-item-center'>\
    						<a href='javascript:;' onclick=pageDoubleBtn('left',"+page+") class='btn btn-primary mr-1 px-2'><i class='fas fa-angle-double-left'></i></a>\
    						<a href='javascript:;' onclick=pageBtn('left',"+page+") class='btn btn-primary mr-1 px-2'><i class='fas fa-angle-left'></i></a>\
    						"+pnu+"\
    						<a href='javascript:;' onclick=pageBtn('right',"+page+") class='btn btn-primary mr-1 px-2'><i class='fas fa-angle-right'></i></a>\
    						<a href='javascript:;' onclick=pageDoubleBtn('right',"+page+") class='btn btn-primary mr-1 px-2'><i class='fas fa-angle-double-right'></i></a>\
    					</div>\
    				");
        		}
        		else if (result.status == 'overSize') {
        			alert("{{__('car_excelsize_error')}}");
        		}
        		else if (result.status == 'sendNull') {
        			alert("{{__('car_nofile_error')}}");
        		}
        		else if (result.status == 'sendFail') {
        			alert("{{__('car_excel_error')}}");
        		}
        	}
		});
	}
	
	// 차량 등록 ajax
	function carJoin() {
		var formParsley  = $('#car-form').parsley();
		if(formParsley.isValid() == true) {
			ajaxJoin('/car/car_join', i18nconvert, { CN: document.getElementsByName("CN")[0].value, CPN: document.getElementsByName("CPN")[0].value });
		}
		event.preventDefault();
	}
	
	// 차량 excel 등록 ajax
	$(document).on('click', '.excelJoinBtn', function() {
		ajaxJoin('/car/car_join_excel', i18nconvert, { excelData: document.getElementsByName("excelData")[0].value });
	});
	
</script>
<script src="../oasisjs/oasis_join.js"></script>
<script src="../assets/plugins/parsleyjs/dist/parsley.min.js"></script>
<script src="../assets/plugins/highlight.js/highlight.min.js"></script>
<script src="../assets/js/demo/render.highlight.js"></script>
{% endblock %}